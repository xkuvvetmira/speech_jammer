<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ses Geciktirici</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts for modern typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #111827; /* Koyu Gri Arkaplan */
        }
        .main-container {
            background-color: #1F2937; /* Daha AÃ§Ä±k Gri Kart */
            border: 1px solid #374151; /* Kart SÄ±nÄ±rÄ± */
        }
        .control-select, .control-button {
            transition: all 0.2s ease-in-out;
        }
        .control-select {
            background-color: #374151;
            border: 1px solid #4B5563;
        }
        .control-select:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .control-button.start {
            background-color: #2563EB; /* Mavi BaÅŸlat Butonu */
            box-shadow: 0 4px 14px 0 rgba(37, 99, 235, 0.39);
        }
        .control-button.start:hover {
            background-color: #1D4ED8;
        }
        .control-button.stop {
            background-color: #DC2626; /* KÄ±rmÄ±zÄ± Durdur Butonu */
            box-shadow: 0 4px 14px 0 rgba(220, 38, 38, 0.39);
        }
        .control-button.stop:hover {
            background-color: #B91C1C;
        }
        .status-badge {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
          0%, 100% {
            opacity: 1;
          }
          50% {
            opacity: .7;
          }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen text-gray-200 p-4">

    <div class="main-container max-w-md w-full p-8 rounded-2xl shadow-2xl space-y-6">
        
        <!-- BaÅŸlÄ±k BÃ¶lÃ¼mÃ¼ -->
        <div class="text-center">
            by kuvvetmira
            <h1 class="text-3xl font-bold text-white">Ses Geciktirici</h1>
            <p class="text-gray-400 mt-2">Kendi sesinizi rahatsÄ±z edici bir gecikmeyle duyun.</p>
        </div>

        <!-- Cihaz SeÃ§im BÃ¶lÃ¼mÃ¼ -->
        <div class="space-y-4">
            <div>
                <label for="audio-input" class="block mb-2 text-sm font-medium text-gray-300">ðŸŽ¤ Mikrofon SeÃ§</label>
                <select id="audio-input" class="control-select w-full p-3 rounded-lg text-white">
                    <option>LÃ¼tfen Ã¶nce mikrofon izni verin...</option>
                </select>
            </div>
        </div>

        <!-- Kontrol ve Durum BÃ¶lÃ¼mÃ¼ -->
        <div class="space-y-4 text-center">
            <button id="toggle-button" class="control-button start w-full py-3 text-lg font-semibold rounded-lg text-white">
                BaÅŸlat
            </button>
            <div id="status-container" class="h-6">
                <p id="status-text" class="text-gray-400">BaÅŸlamak iÃ§in mikrofon seÃ§in.</p>
            </div>
        </div>

    </div>
    
    <!-- Ses Ã§Ä±kÄ±ÅŸÄ± iÃ§in gÃ¶rÃ¼nmez audio elementi -->
    <audio id="output-audio" class="hidden"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // HTML elementlerini seÃ§
            const inputSelect = document.getElementById('audio-input');
            const toggleButton = document.getElementById('toggle-button');
            const statusText = document.getElementById('status-text');
            const outputAudio = document.getElementById('output-audio');

            // Ses iÅŸleme iÃ§in deÄŸiÅŸkenler
            let audioContext;
            let microphoneStream;
            let isRunning = false;

            // Ses cihazlarÄ±nÄ± al ve listele
            async function getAudioDevices() {
                try {
                    // KullanÄ±cÄ±dan mikrofon izni iste
                    // Bu Ã§aÄŸrÄ± olmadan cihaz listesi alÄ±namaz
                    await navigator.mediaDevices.getUserMedia({ audio: true });

                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const audioInputs = devices.filter(device => device.kind === 'audioinput');

                    inputSelect.innerHTML = '';

                    if(audioInputs.length === 0) {
                        inputSelect.innerHTML = '<option>Mikrofon bulunamadÄ±</option>';
                    } else {
                         audioInputs.forEach(device => {
                            const option = new Option(device.label || `Mikrofon ${inputSelect.length + 1}`, device.deviceId);
                            inputSelect.add(option);
                        });
                    }
                   
                    statusText.textContent = 'Cihazlar hazÄ±r. BaÅŸlatmaya hazÄ±r!';

                } catch (error) {
                    console.error("Ses cihazlarÄ±na eriÅŸilemedi:", error);
                    statusText.textContent = "HATA: Mikrofon izni gerekli.";
                    statusText.classList.add('text-red-500');
                    inputSelect.innerHTML = '<option>Ä°zin verilmedi</option>';
                }
            }
            
            // Ses geciktirme iÅŸlemini baÅŸlat
            async function start() {
                if (isRunning) return;

                try {
                    const inputId = inputSelect.value;
                    
                    if (!inputId || inputSelect.options[0].text === 'Ä°zin verilmedi') {
                        statusText.textContent = 'LÃ¼tfen bir mikrofon seÃ§in.';
                        return;
                    }

                    // Yeni bir AudioContext oluÅŸtur
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // SeÃ§ili mikrofondan ses akÄ±ÅŸÄ±nÄ± al
                    const constraints = {
                        audio: {
                            deviceId: { exact: inputId },
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false
                        }
                    };
                    microphoneStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    // AudioContext iÃ§in bir kaynak oluÅŸtur
                    const source = audioContext.createMediaStreamSource(microphoneStream);

                    // Gecikme dÃ¼ÄŸÃ¼mÃ¼ (node) oluÅŸtur
                    const delayNode = audioContext.createDelay();
                    const delayMs = Math.random() * 2 + 199; // 199ms ile 201ms arasÄ±
                    delayNode.delayTime.value = delayMs / 1000;
                    
                    // Sesi direkt AudioContext'in varsayÄ±lan hedefine baÄŸla
                    source.connect(delayNode);
                    delayNode.connect(audioContext.destination);

                    // ArayÃ¼zÃ¼ gÃ¼ncelle
                    isRunning = true;
                    toggleButton.textContent = 'Durdur';
                    toggleButton.className = 'control-button stop w-full py-3 text-lg font-semibold rounded-lg text-white';
                    statusText.innerHTML = `<span class="status-badge">AKTÄ°F | Gecikme: ${delayMs.toFixed(0)}ms</span>`;
                    statusText.classList.remove('text-red-500');

                } catch (error) {
                    console.error("BaÅŸlatma hatasÄ±:", error);
                    statusText.textContent = `HATA: ${error.name}`;
                    statusText.classList.add('text-red-500');
                    await stop(); // Hata durumunda temizle
                }
            }
            
            // Ses geciktirme iÅŸlemini durdur
            async function stop() {
                if (!isRunning) return;

                // Mikrofon akÄ±ÅŸÄ±nÄ± ve izlerini durdur
                if (microphoneStream) {
                    microphoneStream.getTracks().forEach(track => track.stop());
                    microphoneStream = null;
                }
                
                // AudioContext'i kapat ve kaynaklarÄ± serbest bÄ±rak
                if (audioContext) {
                    await audioContext.close();
                    audioContext = null;
                }
                
                // ArayÃ¼zÃ¼ gÃ¼ncelle
                isRunning = false;
                toggleButton.textContent = 'BaÅŸlat';
                toggleButton.className = 'control-button start w-full py-3 text-lg font-semibold rounded-lg text-white';
                statusText.textContent = 'Durduruldu. Tekrar baÅŸlatabilirsiniz.';
                statusText.classList.remove('text-red-500');
            }

            // Butonun tÄ±klama olayÄ±nÄ± yÃ¶net
            toggleButton.addEventListener('click', () => {
                // AudioContext'in kullanÄ±cÄ± etkileÅŸimiyle baÅŸlamasÄ± gerekebilir
                if(!audioContext) {
                    getAudioDevices();
                }

                if (isRunning) {
                    stop();
                } else {
                    start();
                }
            });
        });
    </script>
</body>
</html>
